<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#101624" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>×©×‘×ª ×©×œ×•× TV</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { display: ["'Rubik'", "system-ui", "sans-serif"] },
          colors: { midnight: "#101624", aurum: "#F2C94C" }
        },
      },
    };
  </script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet"/>

  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    :root {
      color-scheme: light;
      --bg-gradient: radial-gradient(140% 200% at 50% 0%, #f9fafc 0%, #edf0ff 35%, #dce2ff 70%, #cfd8ff 100%);
      --panel: rgba(255, 255, 255, 0.95);
      --panel-border: rgba(148, 163, 184, 0.28);
      --panel-shadow: 0 32px 70px rgba(15, 23, 42, 0.12);
      --text-primary: #0f172a;
      --text-secondary: rgba(15, 23, 42, 0.7);
      --accent-primary: #6366f1;
      --accent-secondary: #f97316;
      --accent-tertiary: #0ea5e9;
      --divider: rgba(148, 163, 184, 0.24);
    }

    body {
      font-family: "Rubik", system-ui, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      transition: background 1s ease, color 1s ease;
      overflow: hidden;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
    }

    [class*="text-white/"] {
      color: rgba(15, 23, 42, 0.88) !important;
    }

    /* ×©×‘×ª ×©×œ×•× overlay */
    body.shabbat-active::after {
      content: "×©×‘×ª ×©×œ×•× ğŸŒ™";
      position: fixed;
      inset: 0;
      background: rgba(255, 247, 233, 0.92);
      color: #b45309;
      font-size: clamp(4rem, 8vw, 6rem);
      font-weight: 700;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 2s ease forwards;
    }

    /* ×× ×™××¦×™×•×ª ×›× ×™×¡×” */
    .fade-in {
      opacity: 0;
      transform: translateY(12px);
      animation: fadeIn 0.8s ease forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }

    /* ×¤×¡ ×ª×—×ª×•×Ÿ ×©×œ ×©×‘×ª */
    .shabbat-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 6px;
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.85), rgba(249, 115, 22, 0.85), rgba(14, 165, 233, 0.85));
      transition: opacity 0.6s ease;
      opacity: 0;
    }
    body.shabbat-active .shabbat-bar {
      opacity: 1;
    }

    /* ticker */
    .news-track {
      display: inline-block;
      white-space: nowrap;
      animation: ticker 45s linear infinite;
    }
    @keyframes ticker {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }

    .dashboard-panel {
      border-radius: 0;
      padding: 0;
      height: 100vh;
      max-height: 100vh;
      display: flex;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.82), rgba(226, 232, 255, 0.65));
      overflow: hidden;
    }

    /* ××‘× ×” ×œ×•×— */
    .dashboard-grid {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .dashboard-block {
      display: none;
      height: 100vh;
      max-height: 100vh;
      padding: 1rem;
      position: relative;
      border: none;
      justify-content: flex-start;
      flex-direction: column;
      gap: 0;
      overflow: hidden;
    }

    .dashboard-block.is-active {
      display: flex;
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.96), rgba(230, 237, 255, 0.9));
      border-radius: 1rem;
      border: 1px solid rgba(191, 219, 254, 0.5);
      box-shadow: 0 26px 70px rgba(15, 23, 42, 0.18);
      backdrop-filter: blur(28px);
    }

    .dashboard-cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 1.25rem;
      width: 100%;
      height: 100%;
      flex: 1;
      min-height: 0;
    }

    .dashboard-card-item {
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.95), rgba(240, 247, 255, 0.9));
      border: 1px solid rgba(191, 219, 254, 0.5);
      border-radius: 1.25rem;
      padding: 1.5rem;
      box-shadow: 0 8px 24px rgba(148, 163, 184, 0.12), 0 2px 8px rgba(148, 163, 184, 0.08);
      backdrop-filter: blur(20px);
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      gap: 0.75rem;
    }

    .dashboard-card-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(148, 163, 184, 0.18), 0 4px 12px rgba(148, 163, 184, 0.12);
    }

    .dashboard-card-item:first-child {
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.98), rgba(235, 243, 255, 0.95));
      border-color: rgba(99, 102, 241, 0.3);
      box-shadow: 0 12px 32px rgba(99, 102, 241, 0.15), 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .dashboard-card-item:first-child .clock-display {
      font-size: 3rem;
      font-weight: 700;
      color: rgba(15, 23, 42, 0.95);
      text-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    }

    .dashboard-card-item .clock-display {
      font-size: 2.5rem;
    }

    .dashboard-header {
      border-bottom: 1px solid rgba(148, 163, 184, 0.22);
    }


    .dashboard-stat-card {
      background: linear-gradient(150deg, rgba(248, 250, 255, 0.9), rgba(234, 244, 255, 0.88));
      border: 1px solid rgba(191, 219, 254, 0.55);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8), 0 16px 30px rgba(148, 163, 184, 0.18);
    }

    .dashboard-stat-card label,
    .dashboard-stat-card p {
      margin: 0;
      font-size: 0.75rem;
    }

    .dashboard-stat-card p.text-xl {
      font-size: 0.9rem;
    }

    .city-toggle-wrapper {
      position: absolute;
      top: 1rem;
      left: 1rem;
      z-index: 10;
    }

    .city-toggle-button-subtle {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(191, 219, 254, 0.4);
      color: rgba(15, 23, 42, 0.7);
      cursor: pointer;
      text-align: center;
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.7rem;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .city-toggle-button-subtle:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(99, 102, 241, 0.4);
      color: rgba(15, 23, 42, 0.9);
    }

    .city-toggle-button-subtle:active {
      transform: scale(0.98);
    }

    @media (max-width: 1024px) {
      .dashboard-block {
        padding: 1rem;
        border-radius: 0;
      }

      .dashboard-block.is-active {
        border-radius: 0;
        box-shadow: none;
      }

      .dashboard-cards-grid {
        grid-template-columns: 1fr;
        grid-template-rows: auto;
        gap: 1rem;
      }
    }

    .glass {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 1.55rem;
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(28px);
    }

    .clock-display {
      font-size: 2.5rem;
      letter-spacing: 0.1em;
      font-weight: 600;
      line-height: 1.2;
    }

    .progress-frame {
      width: 100%;
      height: 0.6rem;
      background: rgba(148, 163, 184, 0.15);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(191, 219, 254, 0.2);
    }

    .progress-fill {
      position: absolute;
      inset: 0;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
      transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(99, 102, 241, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    .shabbat-countdown {
      display: block;
      text-align: center;
      font-size: 2.5rem;
      font-weight: 600;
      color: rgba(15, 23, 42, 0.95);
      line-height: 1.2;
      letter-spacing: 0.1em;
      font-variant-numeric: tabular-nums;
      margin-top: 1rem;
    }

    .shabbat-countdown.hidden {
      display: none;
    }

    .select-control {
      width: 100%;
      background: linear-gradient(180deg, rgba(248, 250, 255, 0.95), rgba(233, 238, 255, 0.9));
      border: 1px solid rgba(191, 219, 254, 0.6);
      border-radius: 1rem;
      padding: 0.75rem 1rem;
      color: rgba(15, 23, 42, 0.8);
      font-size: 1.05rem;
      transition: border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
    }

    .select-control:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.65);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    .select-control option {
      color: #0f172a;
      background: #f8fafc;
    }

    body.light-mode .select-control {
      background: rgba(244, 247, 255, 0.95);
      color: #0f172a;
      border-color: rgba(148, 163, 184, 0.45);
    }

    body.light-mode .select-control:focus {
      border-color: rgba(79, 70, 229, 0.55);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.15);
    }

    .heading-glow {
      display: inline-flex;
      gap: 0.5rem;
      align-items: center;
      font-weight: 600;
      position: relative;
      color: var(--text-primary);
      font-size: 1.1rem;
    }

    .dashboard-card-item:first-child .heading-glow {
      font-size: 1.25rem;
      color: rgba(15, 23, 42, 0.95);
    }

    .heading-glow::after {
      content: "";
      display: block;
      height: 2px;
      flex: 1;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(99, 102, 241, 0.7), rgba(249, 115, 22, 0.55), rgba(14, 165, 233, 0.6));
      opacity: 0.75;
    }

    .dashboard-card-item:first-child .heading-glow::after {
      height: 3px;
      opacity: 0.9;
    }

    body.light-mode .heading-glow::after {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.6), rgba(249, 115, 22, 0.6), rgba(14, 165, 233, 0.6));
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    .news-meta span,
    .news-summary,
    .news-list-title,
    .news-source {
      color: var(--text-primary);
    }

    .dashboard-card-item h2,
    .dashboard-card-item h3 {
      color: rgba(15, 23, 42, 0.9);
      font-weight: 600;
    }

    .dashboard-card-item p,
    .dashboard-card-item span {
      color: rgba(15, 23, 42, 0.85);
    }

    .active-city-label {
      color: var(--accent-tertiary);
      font-weight: 600;
      letter-spacing: 0.06em;
    }

    .news-highlight {
      min-height: 3.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      position: relative;
      padding: 0.5rem;
      border-radius: 0.5rem;
      background: linear-gradient(140deg, rgba(255, 255, 255, 0.96), rgba(235, 243, 255, 0.9));
      border: 1px solid rgba(191, 219, 254, 0.55);
      box-shadow: 0 20px 38px rgba(148, 163, 184, 0.22);
      overflow: hidden;
    }

    .news-highlight::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      pointer-events: none;
      background: radial-gradient(120% 120% at 80% 20%, rgba(99, 102, 241, 0.08), rgba(14, 165, 233, 0.04), transparent);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .news-highlight:hover::after {
      opacity: 1;
    }

    .news-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(15, 23, 42, 0.55);
    }

    .news-index {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.12);
      color: rgba(55, 48, 163, 0.9);
      font-weight: 600;
      font-size: 0.7rem;
    }

    .news-summary {
      font-size: 0.75rem;
      line-height: 1.5;
      color: var(--text-secondary);
    }

    .news-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex: 1;
      min-height: 0;
    }

    .news-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin: 0;
      padding: 0;
      max-height: 120px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .news-list-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(191, 219, 254, 0.4);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .news-list-item:hover {
      border-color: rgba(99, 102, 241, 0.45);
      box-shadow: 0 18px 30px rgba(148, 163, 184, 0.2);
    }

    .news-rank {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(99, 102, 241, 0.15);
      color: rgba(55, 48, 163, 0.9);
      font-weight: 600;
      font-size: 0.65rem;
    }

    .news-list-title {
      font-weight: 600;
      font-size: 0.75rem;
      line-height: 1.3;
      color: var(--text-primary);
    }

    .news-source {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      background: rgba(14, 165, 233, 0.12);
      color: rgba(15, 23, 42, 0.7);
      white-space: nowrap;
    }

    .news-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .news-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      background: rgba(99, 102, 241, 0.12);
      color: rgba(55, 48, 163, 0.8);
      font-size: 0.65rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .news-badge::before {
      content: "";
      width: 0.25rem;
      height: 0.25rem;
      border-radius: 999px;
      background: var(--accent-tertiary);
      box-shadow: 0 0 8px rgba(14, 165, 233, 0.45);
    }

    .news-list .panel-soft {
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      background: rgba(248, 250, 255, 0.95);
      border: 1px solid rgba(191, 219, 254, 0.35);
      text-align: center;
      color: rgba(15, 23, 42, 0.7);
      font-size: 0.7rem;
    }

    main {
      padding: 0 !important;
      margin: 0 !important;
      height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    .max-w-7xl {
      max-width: 100%;
      height: 100%;
      margin: 0;
    }

    .dashboard-panel {
      border-radius: 0;
      padding: 0;
      height: 100vh;
      max-height: 100vh;
      display: flex;
    }

    .dashboard-grid {
      display: flex;
      flex-direction: column;
      width: 100%;
    }

    .dashboard-block {
      display: none;
      min-height: 100vh;
      padding: 6vh 8vw;
      border: none !important;
      justify-content: center;
      flex-direction: column;
      gap: 2.5rem;
    }

    .dashboard-block.is-active {
      display: flex;
    }

    footer,
    .shabbat-bar {
      display: none !important;
    }

  </style>
</head>
<body class="min-h-screen flex flex-col light-mode">

  <main class="flex-1 p-0">
    <div class="max-w-7xl h-full">
      <section class="dashboard-panel glass fade-in">
        <div class="dashboard-grid">
          <!-- Header with all cards -->
          <div class="dashboard-block dashboard-header is-active">
            <!-- City toggle - subtle in top right corner -->
            <div class="city-toggle-wrapper">
              <button id="cityToggleButton" class="city-toggle-button-subtle">
                <span id="cityToggleText">××œ×™×›×™×Ÿ</span>
              </button>
            </div>
            
            <!-- All cards grid -->
            <div class="dashboard-cards-grid">
              <!-- ×©×¢×•×Ÿ -->
              <div class="dashboard-card-item text-center">
                <h2 class="text-lg font-semibold mb-2 heading-glow">×©×¢×•×Ÿ ×—×™</h2>
                <div id="clockDisplay" class="clock-display tabular-nums"></div>
                <div id="nextEvent" class="text-sm text-white/90 mt-2 font-medium"></div>
                <div class="mt-4 pt-3 border-t border-white/25">
                  <div class="text-xs text-white/70 mb-1.5 font-medium">×ª××¨×™×š ×œ×•×¢×–×™</div>
                  <div id="gregorianDate" class="text-sm font-semibold mb-3 text-white/90"></div>
                  <div class="text-xs text-white/70 mb-1.5 font-medium">×ª××¨×™×š ×¢×‘×¨×™</div>
                  <div id="hebrewDate" class="text-sm font-semibold text-white/90"></div>
                </div>
              </div>

              <!-- ××–×’ ××•×•×™×¨ -->
              <div class="dashboard-card-item text-right">
                <h2 class="text-lg font-semibold mb-1 heading-glow">××–×’ ××•×•×™×¨</h2>
                <p id="weatherLocation" class="text-white/80 text-xs mb-3 font-medium">××ª×¢×“×›×Ÿ ×œ×¤×™ ×”×¢×™×¨</p>
                <div class="flex justify-between items-center mb-3">
                  <p id="currentWeatherSummary" class="text-sm text-white/90 font-medium"></p>
                  <p id="currentWeatherTemp" class="text-3xl font-bold text-white/95"></p>
                </div>
                <ul id="weatherForecastList" class="grid grid-cols-3 gap-2 text-white/95 text-xs"></ul>
              </div>

              <!-- ×–×× ×™ ×©×‘×ª -->
              <div class="dashboard-card-item text-right">
                <h2 class="text-lg font-semibold mb-1 heading-glow">×–×× ×™ ×©×‘×ª</h2>
                <p id="parasha" class="text-sm text-white/90 mb-3 font-semibold"></p>
                <p class="text-xs mb-2 text-white/85"><strong>×›× ×™×¡×ª ×©×‘×ª:</strong> <span id="candleLighting" class="font-semibold">â€”</span></p>
                <p class="text-xs mb-2 text-white/85"><strong>×¦××ª ×©×‘×ª:</strong> <span id="havdalah" class="font-semibold">â€”</span></p>
                <p id="shabbatStatus" class="text-sm mt-3 font-semibold text-white/90"></p>
                <!-- Countdown to Shabbat -->
                <div id="shabbatCountdown" class="shabbat-countdown mt-3 hidden"></div>
              </div>

              <!-- ×—×“×©×•×ª -->
              <div class="dashboard-card-item text-right">
                <h2 class="text-lg font-semibold mb-1 heading-glow">×—×“×©×•×ª</h2>
                <div class="news-toolbar mb-1">
                  <span class="news-badge">×¢×“×›×•× ×™ ××¢×¨×›×ª</span>
                </div>
                <div class="news-grid">
                  <div class="panel-soft news-highlight" id="newsHighlightCard">
                    <div class="news-meta">
                      <span id="newsSource">××¢×¨×›×ª</span>
                      <span id="newsIndexIndicator" class="news-index"></span>
                    </div>
                    <h3 id="newsHeadline" class="text-sm">××™×Ÿ ×›×•×ª×¨×•×ª ×–××™× ×•×ª ×›×¨×’×¢</h3>
                    <p id="newsSummary" class="news-summary text-xs">× ×™×¡×™×•×Ÿ × ×•×¡×£ ×™×ª×‘×¦×¢ ×‘×¢×•×“ ××¡×¤×¨ ×¨×’×¢×™×.</p>
                  </div>
                  <ul id="newsList" class="news-list"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer - Hidden -->
  <footer class="hidden"></footer>

  <!-- ×¤×¡ ×©×‘×ª -->
  <div class="shabbat-bar"></div>

  <script>
    (() => {
      const CityCatalog = {
        options: [
          { value: "jerusalem", label: "×™×¨×•×©×œ×™×" },
          { value: "tel-aviv", label: "×ª×œ ××‘×™×‘" },
          { value: "haifa", label: "×—×™×¤×”" },
          { value: "beer-sheva", label: "×‘××¨ ×©×‘×¢" },
          { value: "netanya", label: "× ×ª× ×™×”" },
          { value: "ashdod", label: "××©×“×•×“" },
          { value: "ashkel×•×Ÿ", label: "××©×§×œ×•×Ÿ" },
          { value: "tiberias", label: "×˜×‘×¨×™×”" },
          { value: "eilat", label: "××™×œ×ª" },
          { value: "eliakhin", label: "××œ×™×›×™×Ÿ" },
          { value: "mevasseret-zion", label: "××‘×©×¨×ª ×¦×™×•×Ÿ" },
        ],
        coordinates: {
          "jerusalem": { latitude: 31.778, longitude: 35.235 },
          "tel-aviv": { latitude: 32.0853, longitude: 34.7818 },
          "haifa": { latitude: 32.794, longitude: 34.989 },
          "beer-sheva": { latitude: 31.251, longitude: 34.791 },
          "netanya": { latitude: 32.321, longitude: 34.853 },
          "ashdod": { latitude: 31.801, longitude: 34.643 },
          "ashkel×•×Ÿ": { latitude: 31.669, longitude: 34.571 },
          "tiberias": { latitude: 32.7922, longitude: 35.5322 },
          "eilat": { latitude: 29.5581, longitude: 34.9482 },
          "eliakhin": { latitude: 32.412, longitude: 35.004 },
          "mevasseret-zion": { latitude: 31.807, longitude: 35.146 },
        },
        default() {
          return this.options.find((city) => city.value === "eliakhin")?.value ?? this.options[0]?.value ?? "jerusalem";
        },
        list() {
          return this.options;
        },
        label(id) {
          return this.options.find((city) => city.value === id)?.label ?? id;
        },
        coords(id) {
          return this.coordinates[id] ?? null;
        },
      };

      const AppConfig = {
        defaultCity: CityCatalog.default(),
        refresh: {
          clock: 1000,
          shabbat: 10 * 60 * 1000,
          weather: 30 * 60 * 1000,
          news: 15 * 60 * 1000,
          calendar: 60 * 60 * 1000,
          newsRotation: 15000,
          cards: 15000,
        },
        rssFeeds: [
          { name: "Ynet", url: `https://api.allorigins.win/raw?url=${encodeURIComponent("https://www.ynet.co.il/Integration/StoryRss1854.xml")}` },
          { name: "N12", url: `https://api.allorigins.win/raw?url=${encodeURIComponent("https://rss.n12.co.il/?s=network")}` },
          { name: "Rotter", url: `https://api.allorigins.win/raw?url=${encodeURIComponent("https://rotter.net/rss/all_ticker.xml")}` },
        ],
      };

      const Formatters = {
        gregorian: new Intl.DateTimeFormat("he-IL", {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        }),
        weekday: new Intl.DateTimeFormat("he-IL", { weekday: "long" }),
        time: new Intl.DateTimeFormat("he-IL", { hour: "2-digit", minute: "2-digit" }),
        timeWithSeconds: new Intl.DateTimeFormat("he-IL", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        }),
      };

      const DOM = {
        clockDisplay: document.getElementById("clockDisplay"),
        nextEvent: document.getElementById("nextEvent"),
        gregorianDate: document.getElementById("gregorianDate"),
        hebrewDate: document.getElementById("hebrewDate"),
        citySelect: document.getElementById("citySelect"),
        activeCityLabel: document.getElementById("activeCityLabel"),
        cityToggleButton: document.getElementById("cityToggleButton"),
        cityToggleText: document.getElementById("cityToggleText"),
        candleLighting: document.getElementById("candleLighting"),
        havdalah: document.getElementById("havdalah"),
        shabbatStatus: document.getElementById("shabbatStatus"),
        shabbatCountdown: document.getElementById("shabbatCountdown"),
        parasha: document.getElementById("parasha"),
        timeProgressFill: document.getElementById("timeProgressFill"),
        weatherLocation: document.getElementById("weatherLocation"),
        currentWeatherTemp: document.getElementById("currentWeatherTemp"),
        currentWeatherSummary: document.getElementById("currentWeatherSummary"),
        weatherForecastList: document.getElementById("weatherForecastList"),
        newsHighlightCard: document.getElementById("newsHighlightCard"),
        newsHeadline: document.getElementById("newsHeadline"),
        newsSummary: document.getElementById("newsSummary"),
        newsSource: document.getElementById("newsSource"),
        newsIndexIndicator: document.getElementById("newsIndexIndicator"),
        newsList: document.getElementById("newsList"),
        refreshNewsButton: document.getElementById("refreshNewsButton"),
        fullscreenButton: document.getElementById("fullscreenButton"),
      };

      const AppState = {
        cityId: AppConfig.defaultCity,
        sunTimes: { sunrise: null, sunset: null },
        shabbat: { candleLighting: null, havdalah: null, parasha: "" },
        calendar: { gregorian: "", hebrew: "" },
        weather: { current: null, forecast: [] },
        news: { items: [], index: 0 },
      };

      const Cache = {
        hebrewDayStamp: "",
        shabbatSignature: "",
        weatherSignature: "",
        newsSignature: "",
      };

      const WeatherDictionary = {
        map: {
          0: "â˜€ï¸ ×©××™×™× ×‘×”×™×¨×™×",
          1: "ğŸŒ¤ï¸ ××¢×•× ×Ÿ ×§×œ",
          2: "â›… ××¢×•× ×Ÿ ×—×œ×§×™×ª",
          3: "â˜ï¸ ××¢×•× ×Ÿ",
          45: "ğŸŒ«ï¸ ×¢×¨×¤×œ",
          48: "ğŸŒ«ï¸ ×¢×¨×¤×œ ×§×¤×•×",
          51: "ğŸŒ¦ï¸ ×˜×¤×˜×•×£ ×§×œ",
          53: "ğŸŒ¦ï¸ ×˜×¤×˜×•×£",
          55: "ğŸŒ§ï¸ ×˜×¤×˜×•×£ ×—×–×§",
          61: "ğŸŒ§ï¸ ×’×©× ×§×œ",
          63: "ğŸŒ§ï¸ ×’×©× ×‘×™× ×•× ×™",
          65: "ğŸŒ§ï¸ ×’×©× ×—×–×§",
          71: "ğŸŒ¨ï¸ ×©×œ×’ ×§×œ",
          73: "ğŸŒ¨ï¸ ×©×œ×’",
          75: "â„ï¸ ×©×œ×’ ×›×‘×“",
          80: "ğŸŒ¦ï¸ ×××˜×¨×™×",
          81: "ğŸŒ§ï¸ ×××˜×¨×™× ×‘×™× ×•× ×™×™×",
          82: "â›ˆï¸ ×××˜×¨×™× ×—×–×§×™×",
          95: "â›ˆï¸ ×¡×•×¤×•×ª ×¨×¢××™×",
          96: "â›ˆï¸ ×¡×•×¤×•×ª ×¨×¢××™× ×¢× ×‘×¨×“",
          99: "â›ˆï¸ ×¡×•×¤×•×ª ×¨×¢××™× ×¢× ×‘×¨×“ ×›×‘×“",
        },
        describe(code) {
          return this.map[code] ?? "×¢×“×›×•×Ÿ ××–×’ ××•×•×™×¨";
        },
      };

      const Utils = {
        dayStamp(date) {
          return date.toISOString().slice(0, 10);
        },
        fetchWithTimeout(url, { timeout = 12000 } = {}) {
          const controller = new AbortController();
          const id = setTimeout(() => controller.abort(), timeout);
          return fetch(url, { signal: controller.signal }).finally(() => clearTimeout(id));
        },
        sanitize(text) {
          if (!text) return "";
          const tmp = document.createElement("div");
          tmp.innerHTML = text;
          return tmp.textContent?.trim() ?? "";
        },
        formatTime(date) {
          return Formatters.time.format(date);
        },
        formatTimeFull(date) {
          return Formatters.timeWithSeconds.format(date).replace(/\./g, ":");
        },
        computeProgress(now, start, end) {
          const total = end - start;
          if (total <= 0) return 0;
          return Math.min(100, Math.max(0, ((now - start) / total) * 100));
        },
        temperatureColor(value) {
          if (value > 30) return "#ff7676";
          if (value > 20) return "#f6c870";
          if (value > 10) return "#58d6ff";
          return "#a0b8ff";
        },
      };

      const Http = {
        async json(url, options) {
          const response = await Utils.fetchWithTimeout(url, options);
          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`);
          }
          return response.json();
        },
        async text(url, options) {
          const response = await Utils.fetchWithTimeout(url, options);
          if (!response.ok) {
            throw new Error(`Request failed: ${response.status}`);
          }
          return response.text();
        },
      };

      const UI = {
        populateCities() {
          if (!DOM.citySelect) return;
          DOM.citySelect.innerHTML = "";
          CityCatalog.list().forEach((city) => {
            const option = document.createElement("option");
            option.value = city.value;
            option.textContent = city.label;
            DOM.citySelect.appendChild(option);
          });
          DOM.citySelect.value = AppState.cityId;
          this.updateActiveCityLabel();
        },
        updateActiveCityLabel() {
          if (DOM.activeCityLabel) {
            DOM.activeCityLabel.textContent = CityCatalog.label(AppState.cityId);
          }
          if (DOM.cityToggleText) {
            DOM.cityToggleText.textContent = CityCatalog.label(AppState.cityId);
          }
        },
        toggleCityLoading(isLoading) {
          if (!DOM.citySelect) return;
          DOM.citySelect.disabled = isLoading;
          DOM.citySelect.classList.toggle("opacity-60", isLoading);
        },
        renderCalendar({ gregorian, hebrew }) {
          if (DOM.gregorianDate) DOM.gregorianDate.textContent = gregorian;
          if (DOM.hebrewDate) DOM.hebrewDate.textContent = hebrew;
        },
        renderShabbatTimes() {
          const { candleLighting, havdalah, parasha } = AppState.shabbat;
          if (DOM.candleLighting) DOM.candleLighting.textContent = candleLighting ? Utils.formatTime(candleLighting) : "â€”";
          if (DOM.havdalah) DOM.havdalah.textContent = havdalah ? Utils.formatTime(havdalah) : "â€”";
          if (DOM.parasha) DOM.parasha.textContent = parasha ? `×¤×¨×©×ª ${parasha}` : "";
        },
        renderWeather() {
          const { current, forecast } = AppState.weather;
          if (!current) return;

          if (DOM.weatherLocation) DOM.weatherLocation.textContent = `×ª×—×–×™×ª ×¢×‘×•×¨ ${CityCatalog.label(AppState.cityId)}`;
          if (DOM.currentWeatherTemp) {
            DOM.currentWeatherTemp.textContent = `${Math.round(current.temperature)}Â°`;
            DOM.currentWeatherTemp.style.color = Utils.temperatureColor(current.temperature);
          }
          if (DOM.currentWeatherSummary) DOM.currentWeatherSummary.textContent = current.description;

          if (DOM.weatherForecastList) {
            DOM.weatherForecastList.innerHTML = "";
            forecast.forEach((day) => {
              const li = document.createElement("li");
              li.className = "p-1 rounded-lg bg-white/5 text-center";
              li.innerHTML = `
                <div class="text-xs">${Formatters.weekday.format(day.date)}</div>
                <div class="text-xs">${WeatherDictionary.describe(day.code)}</div>
                <div class="text-xs">${Math.round(day.max)}Â° / ${Math.round(day.min)}Â°</div>
              `;
              DOM.weatherForecastList.appendChild(li);
            });
          }
        },
        renderWeatherError() {
          if (DOM.weatherLocation) DOM.weatherLocation.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×—×–×™×ª";
          if (DOM.currentWeatherTemp) {
            DOM.currentWeatherTemp.textContent = "â€”";
            DOM.currentWeatherTemp.style.color = "";
          }
          if (DOM.currentWeatherSummary) DOM.currentWeatherSummary.textContent = "";
          if (DOM.weatherForecastList) DOM.weatherForecastList.innerHTML = "";
        },
        renderNewsHighlight({ animate } = { animate: true }) {
          if (!DOM.newsHighlightCard) return;
          const items = AppState.news.items;
          if (!items.length) {
            this.renderNewsEmpty();
            return;
          }

          const index = AppState.news.index % items.length;
          const current = items[index];

          const apply = () => {
            if (DOM.newsSource) DOM.newsSource.textContent = current.source ?? "â€”";
            if (DOM.newsHeadline) DOM.newsHeadline.textContent = current.title ?? "";
            if (DOM.newsSummary) DOM.newsSummary.textContent = current.summary ?? "";
            if (DOM.newsIndexIndicator) DOM.newsIndexIndicator.textContent = `${index + 1}/${items.length}`;
            this.renderNewsList(index);
          };

          if (animate) {
            DOM.newsHighlightCard.classList.add("is-fading");
            setTimeout(() => {
              apply();
              DOM.newsHighlightCard.classList.remove("is-fading");
            }, 220);
          } else {
            apply();
            DOM.newsHighlightCard.classList.remove("is-fading");
          }
        },
        renderNewsList(activeIndex) {
          if (!DOM.newsList) return;
          DOM.newsList.innerHTML = "";

          const items = AppState.news.items;
          const upcoming = [...items.slice(activeIndex + 1), ...items.slice(0, activeIndex)].slice(0, 4);

          if (!upcoming.length) {
            const li = document.createElement("li");
            li.className = "panel-soft";
            li.textContent = "××™×Ÿ ×›×•×ª×¨×•×ª × ×•×¡×¤×•×ª ×›×¢×ª.";
            DOM.newsList.appendChild(li);
            return;
          }

          upcoming.forEach((item, idx) => {
            const li = document.createElement("li");
            li.className = "news-list-item";

            const rank = document.createElement("span");
            rank.className = "news-rank";
            rank.textContent = `${idx + 1}`;

            const title = document.createElement("span");
            title.className = "news-list-title";
            title.textContent = item.title;

            const source = document.createElement("span");
            source.className = "news-source";
            source.textContent = item.source ?? "â€”";

            li.append(rank, title, source);
            DOM.newsList.appendChild(li);
          });
        },
        renderNewsEmpty() {
          if (DOM.newsSource) DOM.newsSource.textContent = "××¢×¨×›×ª";
          if (DOM.newsHeadline) DOM.newsHeadline.textContent = "××™×Ÿ ×›×•×ª×¨×•×ª ×–××™× ×•×ª ×›×¨×’×¢";
          if (DOM.newsSummary) DOM.newsSummary.textContent = "× ×™×¡×™×•×Ÿ × ×•×¡×£ ×™×ª×‘×¦×¢ ×‘×¢×•×“ ××¡×¤×¨ ×¨×’×¢×™×.";
          if (DOM.newsIndexIndicator) DOM.newsIndexIndicator.textContent = "";
          if (DOM.newsList) DOM.newsList.innerHTML = "";
        },
      };

      const Theme = {
        apply() {
          document.body.classList.add("light-mode");
        },
      };

      const ShabbatStatus = {
        update() {
          const { candleLighting, havdalah } = AppState.shabbat;
          const now = new Date();

          if (!candleLighting || !havdalah) {
            if (DOM.shabbatStatus) DOM.shabbatStatus.textContent = "×××ª×™×Ÿ ×œ×–×× ×™ ×©×‘×ª";
            if (DOM.nextEvent) DOM.nextEvent.textContent = "";
            if (DOM.shabbatCountdown) DOM.shabbatCountdown.classList.add("hidden");
            document.body.classList.remove("shabbat-active");
            return;
          }

          let label = "";
          let next = "";
          let progress = 0;

          if (now >= candleLighting && now <= havdalah) {
            const hoursLeft = Math.max(0, Math.round((havdalah - now) / 36e5));
            label = "×©×‘×ª ×‘×¢×™×¦×•××” ğŸŒ™";
            next = `×¦××ª ×©×‘×ª ×‘-${Utils.formatTime(havdalah)}${hoursLeft ? ` (×›-${hoursLeft} ×©×¢×•×ª)` : ""}`;
            progress = Utils.computeProgress(now, candleLighting, havdalah);
            document.body.classList.add("shabbat-active");
            if (DOM.shabbatCountdown) DOM.shabbatCountdown.classList.add("hidden");
          } else if (now < candleLighting) {
            const startOfDay = new Date(now);
            startOfDay.setHours(0, 0, 0, 0);
            label = "×”×›× ×•×ª ×œ×©×‘×ª ğŸ•¯ï¸";
            next = `×›× ×™×¡×ª ×©×‘×ª ×‘-${Utils.formatTime(candleLighting)}`;
            progress = Utils.computeProgress(now, startOfDay, candleLighting);
            document.body.classList.remove("shabbat-active");
            this.renderCountdown(candleLighting, now);
          } else {
            label = "×©×‘×•×¢ ×˜×•×‘ ğŸŒ…";
            next = "×”×©×‘×ª ×”×¡×ª×™×™××” â€“ ×©×‘×•×¢ × ×¤×œ×!";
            progress = 100;
            document.body.classList.remove("shabbat-active");
            if (DOM.shabbatCountdown) DOM.shabbatCountdown.classList.add("hidden");
          }

          if (DOM.shabbatStatus) DOM.shabbatStatus.textContent = label;
          if (DOM.nextEvent) DOM.nextEvent.textContent = next;
        },
        renderCountdown(targetTime, now) {
          if (!DOM.shabbatCountdown) return;
          
          const diff = targetTime - now;
          if (diff <= 0) {
            DOM.shabbatCountdown.classList.add("hidden");
            return;
          }

          DOM.shabbatCountdown.classList.remove("hidden");
          
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          const hoursStr = hours.toString().padStart(2, '0');
          const minutesStr = minutes.toString().padStart(2, '0');
          const secondsStr = seconds.toString().padStart(2, '0');
          
          DOM.shabbatCountdown.innerHTML = `${hoursStr}:${minutesStr}:${secondsStr}`;
        },
      };

      const CalendarService = {
        async load(force = false) {
          const now = new Date();
          const stamp = Utils.dayStamp(now);
          if (!force && Cache.hebrewDayStamp === stamp) {
            UI.renderCalendar(AppState.calendar);
            return;
          }

          const gregorian = Formatters.gregorian.format(now);
          try {
            const url = `https://www.hebcal.com/converter/?cfg=json&g2h=1&strict=1&date=${stamp}`;
            const data = await Http.json(url);
            AppState.calendar = { gregorian, hebrew: data.hebrew ?? "â€”" };
            Cache.hebrewDayStamp = stamp;
            UI.renderCalendar(AppState.calendar);
          } catch (error) {
            console.error("Hebrew date error", error);
            AppState.calendar = { gregorian, hebrew: "×©×’×™××” ×‘×—×™×©×•×‘ ×ª××¨×™×š" };
            UI.renderCalendar(AppState.calendar);
          }
        },
      };

      const ShabbatService = {
        async load(force = false) {
          const coords = CityCatalog.coords(AppState.cityId);
          const base = coords
            ? `latitude=${coords.latitude}&longitude=${coords.longitude}&tzid=Asia/Jerusalem`
            : `city=${encodeURIComponent(AppState.cityId)}`;
          const url = `https://www.hebcal.com/shabbat/?cfg=json&${base}&m=50&leyning=on`;

          try {
            const data = await Http.json(url);
            const signature = JSON.stringify({
              city: AppState.cityId,
              items: (data.items ?? []).slice(0, 6).map((item) => [item.category, item.date]),
            });

            if (!force && signature === Cache.shabbatSignature) {
              UI.renderShabbatTimes();
              ShabbatStatus.update();
              Theme.apply();
              return;
            }

            Cache.shabbatSignature = signature;
            const candle = data.items?.find((item) => item.category === "candles") ?? null;
            const havdalah = data.items?.find((item) => item.category === "havdalah") ?? null;
            const parasha = data.items?.find((item) => item.category === "parashat")?.hebrew ?? "";

            AppState.shabbat = {
              candleLighting: candle ? new Date(candle.date) : null,
              havdalah: havdalah ? new Date(havdalah.date) : null,
              parasha,
            };

            if (data.location?.sunrise) AppState.sunTimes.sunrise = new Date(data.location.sunrise);
            if (data.location?.sunset) AppState.sunTimes.sunset = new Date(data.location.sunset);

            UI.renderShabbatTimes();
            ShabbatStatus.update();
            Theme.apply();
          } catch (error) {
            console.error("Shabbat API error", error);
            if (DOM.shabbatStatus) DOM.shabbatStatus.textContent = "×ª×§×œ×” ×‘×–×× ×™ ×©×‘×ª";
            if (DOM.nextEvent) DOM.nextEvent.textContent = "";
            if (DOM.shabbatCountdown) DOM.shabbatCountdown.classList.add("hidden");
          }
        },
      };

      const WeatherService = {
        async load(force = false) {
          const coords = CityCatalog.coords(AppState.cityId);
          if (!coords) {
            UI.renderWeatherError();
            return;
          }

          const url = `https://api.open-meteo.com/v1/forecast?latitude=${coords.latitude}&longitude=${coords.longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&timezone=auto&forecast_days=3`;

          try {
            const data = await Http.json(url);
            const signature = JSON.stringify({
              city: AppState.cityId,
              current: data.current_weather?.time,
              daily: data.daily?.time ?? [],
            });

            if (!force && signature === Cache.weatherSignature) {
              UI.renderWeather();
              return;
            }

            Cache.weatherSignature = signature;
            const current = data.current_weather ?? null;
            const daily = data.daily ?? {};

            AppState.weather.current = current
              ? {
                  temperature: current.temperature,
                  description: WeatherDictionary.describe(current.weathercode),
                }
              : null;

            AppState.weather.forecast = (daily.time ?? []).map((date, index) => ({
              date: new Date(date),
              max: daily.temperature_2m_max?.[index],
              min: daily.temperature_2m_min?.[index],
              precipitation: daily.precipitation_probability_max?.[index],
              code: daily.weathercode?.[index],
            }));

            if (daily.sunrise?.[0]) AppState.sunTimes.sunrise = new Date(daily.sunrise[0]);
            if (daily.sunset?.[0]) AppState.sunTimes.sunset = new Date(daily.sunset[0]);

            UI.renderWeather();
            Theme.apply();
          } catch (error) {
            console.error("Weather API error", error);
            UI.renderWeatherError();
          }
        },
      };

      const NewsService = {
        async load(force = false) {
          if (!force && Cache.newsSignature && AppState.news.items.length) {
            UI.renderNewsHighlight({ animate: false });
            return;
          }

          const all = [];
          await Promise.all(
            AppConfig.rssFeeds.map(async (feed) => {
              try {
                const xmlText = await Http.text(feed.url, { timeout: 10000 });
                const xmlDoc = new DOMParser().parseFromString(xmlText, "application/xml");
                const items = Array.from(xmlDoc.querySelectorAll("item")).slice(0, 12);
                items.forEach((node) => {
                  const title = Utils.sanitize(node.querySelector("title")?.textContent ?? "");
                  if (!title) return;
                  const summary = Utils.sanitize(node.querySelector("description")?.textContent ?? "");
                  all.push({ source: feed.name, title, summary });
                });
              } catch (error) {
                console.error("RSS error", feed.name, error);
              }
            })
          );

          const signature = JSON.stringify(all.slice(0, 6));
          if (!force && signature === Cache.newsSignature) {
            return;
          }

          Cache.newsSignature = signature;
          AppState.news = { items: all, index: 0 };

          if (!all.length) {
            UI.renderNewsEmpty();
            NewsTicker.stop();
            return;
          }

          UI.renderNewsHighlight({ animate: false });
          NewsTicker.restart();
        },
      };

      const NewsTicker = {
        timer: null,
        start() {
          this.stop();
          if (AppState.news.items.length > 1) {
            this.timer = setInterval(() => this.next(), AppConfig.refresh.newsRotation);
          }
        },
        stop() {
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        },
        restart() {
          this.stop();
          this.start();
        },
        next() {
          if (!AppState.news.items.length) return;
          AppState.news.index = (AppState.news.index + 1) % AppState.news.items.length;
          UI.renderNewsHighlight({ animate: true });
        },
      };

      const CardRotator = {
        blocks: [],
        index: 0,
        timer: null,
        init() {
          // All cards are now displayed together in the header, no rotation needed
          const headerBlock = document.querySelector(".dashboard-block.dashboard-header");
          if (headerBlock) {
            headerBlock.classList.add("is-active");
          }
        },
        start() {
          // Disabled - all cards are shown together
        },
        stop() {
          if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
          }
        },
        next() {
          // Disabled - all cards are shown together
        },
      };

      const Clock = {
        tick() {
          const now = new Date();
          if (DOM.clockDisplay) {
            DOM.clockDisplay.textContent = Utils.formatTimeFull(now);
          }
          Theme.apply();
          ShabbatStatus.update(); // Updates countdown every second
        },
      };

      const TaskRunner = {
        timers: new Map(),
        register(key, fn, interval) {
          this.cancel(key);
          this.timers.set(key, setInterval(fn, interval));
        },
        cancel(key) {
          if (this.timers.has(key)) {
            clearInterval(this.timers.get(key));
            this.timers.delete(key);
          }
        },
        stopAll() {
          this.timers.forEach((timer) => clearInterval(timer));
          this.timers.clear();
          NewsTicker.stop();
          CardRotator.stop();
        },
        start() {
          this.register("clock", () => Clock.tick(), AppConfig.refresh.clock);
          this.register("shabbat", () => ShabbatService.load(false), AppConfig.refresh.shabbat);
          this.register("weather", () => WeatherService.load(false), AppConfig.refresh.weather);
          this.register("news", () => NewsService.load(true), AppConfig.refresh.news);
          this.register("calendar", () => CalendarService.load(false), AppConfig.refresh.calendar);
        },
      };

      const App = {
        async boot() {
          UI.populateCities();
          UI.updateActiveCityLabel();
          this.bindEvents();

          CardRotator.init();
          await this.initialFetch();
          Clock.tick();
          TaskRunner.start();
        },
        async initialFetch() {
          UI.toggleCityLoading(true);
          try {
            await Promise.all([
              CalendarService.load(true),
              ShabbatService.load(true),
              WeatherService.load(true),
              NewsService.load(true),
            ]);
          } finally {
            UI.toggleCityLoading(false);
          }
        },
        async changeCity(cityId) {
          if (cityId === AppState.cityId) return;
          AppState.cityId = cityId;
          if (DOM.citySelect) DOM.citySelect.value = cityId;
          UI.updateActiveCityLabel();
          Cache.shabbatSignature = "";
          Cache.weatherSignature = "";
          await this.refreshCity(true);
        },
        async refreshCity(force = false) {
          UI.toggleCityLoading(true);
          try {
            await Promise.all([ShabbatService.load(force), WeatherService.load(force)]);
          } finally {
            UI.toggleCityLoading(false);
          }
        },
        bindEvents() {
          if (DOM.citySelect) {
            DOM.citySelect.addEventListener("change", (event) => this.changeCity(event.target.value));
          }

          if (DOM.cityToggleButton) {
            DOM.cityToggleButton.addEventListener("click", () => {
              const currentCity = AppState.cityId;
              const nextCity = currentCity === "eliakhin" ? "mevasseret-zion" : "eliakhin";
              this.changeCity(nextCity);
            });
          }

          if (DOM.refreshNewsButton) {
            DOM.refreshNewsButton.addEventListener("click", () => {
              Cache.newsSignature = "";
              NewsService.load(true);
            });
          }

          if (DOM.fullscreenButton) {
            DOM.fullscreenButton.addEventListener("click", () => this.requestFullscreen());
          }

          document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
              TaskRunner.stopAll();
            } else {
              Clock.tick();
              TaskRunner.start();
              this.refreshCity(false);
              NewsService.load(true);
              CalendarService.load(false);
            }
          });

          window.addEventListener("online", () => {
            Cache.newsSignature = "";
            Cache.weatherSignature = "";
            Cache.shabbatSignature = "";
            this.refreshCity(true);
            NewsService.load(true);
          });
        },
        requestFullscreen() {
          const root = document.documentElement;
          if (root.requestFullscreen) {
            root.requestFullscreen().catch(() => {});
          }
        },
      };

      document.addEventListener("DOMContentLoaded", () => App.boot());
    })();
  </script>
</body>
</html>
